<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="EonDice">
    <Require feature="rpc"/>
    <Require feature="views"/>
  </ModulePrefs>
  <Content type="html">
    <![CDATA[

<html>
<body>
  <script src="//plus.google.com/hangouts/_/api/v1/hangout.js"></script>
  <h2>EonDice v1.1</h2>

  <div>
    <textarea id="output" rows="5" cols="30" readonly>
    </textarea>
  </div>

  <div>
    <input id="input" type="number" size="30" value="0"/>
  </div>

  <div class="numRow">
    <input id="K7" type="button" value="7" onclick="key_7();"/>
    <input id="K8" type="button" value="8" onclick="key_8();"/>
    <input id="K9" type="button" value="9" onclick="key_9();"/>
  </div>

  <div class="numRow">
    <input id="K4" type="button" value="4" onclick="key_4();"/>
    <input id="K5" type="button" value="5" onclick="key_5();"/>
    <input id="K6" type="button" value="6" onclick="key_6();"/>
  </div>

  <div class="numRow">
    <input id="K1" type="button" value="1" onclick="key_1();"/>
    <input id="K2" type="button" value="2" onclick="key_2();"/>
    <input id="K3" type="button" value="3" onclick="key_3();"/>
  </div>

  <div class="numRow">
    <input id="KC" type="button" value="C" onclick="key_C();"/>
    <input id="K0" type="button" value="0" onclick="key_0();"/>
    <input id="KB" type="button" value="&#x232b;" onclick="key_backspace();"/>
  </div>

  <div>
    <input id="T10" type="button" value="Slå 1T10" onclick="t10();"/>
    <input id="T6" type="button" value="Slå nT6" onclick="t6();"/>
  </div>

  <h3>Enskilda slag:</h3>
  <textarea id="debug" rows="5" cols="30" readonly>
  </textarea>

  <script>
function onMessageRecieved(event) {
    var out = document.getElementById("output");

    try {
        var data = JSON.parse(event.message);
        var username = gapi.hangout.getParticipantById(event.senderId).person.displayName;

        out.value = username + " " + parseInt(data[0]) + "T" + parseInt(data[1]) + ": " + parseInt(data[2]) + "\n" + out.value;
    } catch (e) {
        console.log(e);
    }
}

function init() {
    gapi.hangout.onApiReady.add(
        function(eventObj) {
            if (eventObj.isApiReady) {
                try {
                    gapi.hangout.data.onMessageRecieved.add(onMessageRecieved);
                } catch (e) {
                    console.log('init:ERROR');
                    console.log(e);
                }
            }
        }
    );
}

function t10() {
    var dbg = document.getElementById("debug");
    var out = document.getElementById("output");
    var roll = 0;

    dbg.value = "...";
    roll = httpGet("https://www.random.org/integers/?num=1&min=1&max=10&col=1&base=10&format=plain&rnd=new");

    dbg.value = roll;
    out.value = "Jag 1T10: " + roll + out.value;
    gapi.hangout.data.sendMessage(
        JSON.stringify([1,
                        10,
                        roll])
    );
}

function t6() {
    var dbg = document.getElementById("debug");
    var inp = document.getElementById("input");
    var out = document.getElementById("output");
    var num = inp.value;
    var tmpNum = num;
    var sum = 0;
    var tmpDbg = "";

    dbg.value = "...";
    var rolls = httpGet("https://www.random.org/integers/?num=" + num + "&min=1&max=6&col=" + num + "&base=10&format=plain&rnd=new").split("\t");
    var sexor = 0;

    for (var i = 0; i < rolls.length; i++) {
        rolls[i] = parseInt(rolls[i], 10);

        if (rolls[i] == 6) {
            sexor++;
        } else {
            sum += rolls[i];
        }
    }

    dbg.value = rolls;

    while (sexor > 0) {
        tmpDbg = dbg.value;
        num = sexor * 2;
        sexor = 0;

        dbg.value = tmpDbg + "\n...";

        rolls = httpGet("https://www.random.org/integers/?num=" + num + "&min=1&max=6&col=" + num + "&base=10&format=plain&rnd=new").split("\t");

        for (var i = 0; i < rolls.length; i++) {
            rolls[i] = parseInt(rolls[i], 10);

            if (rolls[i] == 6) {
                sexor++;
            } else {
                sum += rolls[i];
            }
        }

        dbg.value = tmpDbg + "\n" + rolls;
    }

    out.value = "Jag " + tmpNum + "T6: " + sum + "\n" + out.value;
    gapi.hangout.data.sendMessage(
        JSON.stringify([tmpNum,
                        6,
                        sum])
    );
}

function httpGet(theUrl) {
    var xmlHttp = null;

    xmlHttp = new XMLHttpRequest();
    xmlHttp.open("GET", theUrl, false);
    xmlHttp.send(null);

    return xmlHttp.responseText;
}

function key_C() {
    document.getElementById("input").value = 0;
}

function key_backspace() {
    var inp = document.getElementById("input");
    inp.value = Math.floor(inp.value / 10);
}

function key_0() {
    document.getElementById("input").value *= 10;
}

function key_1() {
    var inp = document.getElementById("input");
    inp.value = inp.value * 10 + 1;
}

function key_2() {
    var inp = document.getElementById("input");
    inp.value = inp.value * 10 + 2;
}

function key_3() {
    var inp = document.getElementById("input");
    inp.value = inp.value * 10 + 3;
}

function key_4() {
    var inp = document.getElementById("input");
    inp.value = inp.value * 10 + 4;
}

function key_5() {
    var inp = document.getElementById("input");
    inp.value = inp.value * 10 + 5;
}

function key_6() {
    var inp = document.getElementById("input");
    inp.value = inp.value * 10 + 6;
}

function key_7() {
    var inp = document.getElementById("input");
    inp.value = inp.value * 10 + 7;
}

function key_8() {
    var inp = document.getElementById("input");
    inp.value = inp.value * 10 + 8;
}

function key_9() {
    var inp = document.getElementById("input");
    inp.value = inp.value * 10 + 9;
}

gadgets.util.registerOnLoadHandler(init);
  </script>
</body>
</html>

    ]]>
  </Content>
</Module>
